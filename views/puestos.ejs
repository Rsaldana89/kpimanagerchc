<%- include('partials/header') %>
<h2 class="mb-4">Puestos</h2>

<p>A continuación se listan todos los puestos configurados en el sistema.  Puede editar el nombre del puesto, su departamento y a quién responde directamente.  También puede hacer clic en "Asignar KPIs" para definir qué indicadores aplican a cada puesto.  En la parte inferior puede crear nuevos departamentos, agregar sucursales al departamento OPERACIONES o crear un puesto nuevo.</p>

<% 
  // Agrupar puestos por departamento para mostrar secciones más claras
  const deptMap = {};
  puestos.forEach(p => {
    const dep = p.departamento || 'SIN DEPARTAMENTO';
    if (!deptMap[dep]) deptMap[dep] = [];
    deptMap[dep].push(p);
  });

  // Orden sugerido (si existe). El resto se ordena alfabéticamente.
  const preferredOrder = ['DIRECCION', 'DIRECCIÓN', 'EYE', 'SISTEMAS', 'CAPITAL HUMANO', 'OPERACIONES'];
  const deptNames = Object.keys(deptMap).sort((a, b) => {
    const ia = preferredOrder.indexOf(a);
    const ib = preferredOrder.indexOf(b);
    if (ia !== -1 || ib !== -1) {
      if (ia === -1) return 1;
      if (ib === -1) return -1;
      return ia - ib;
    }
    return a.localeCompare(b, 'es');
  });
%>

<div class="accordion" id="puestosAccordion">
  <% deptNames.forEach((depName, depIdx) => { %>
    <% 
      // Copia y orden interno por claridad
      let list = deptMap[depName].slice();
      // Caso especial: EYE muestra primero GERENTE GENERAL (si existe)
      if ((depName || '').toUpperCase() === 'EYE') {
        list.sort((a, b) => {
          const aGG = (a.puesto || '').toUpperCase().includes('GERENTE GENERAL') ? 0 : 1;
          const bGG = (b.puesto || '').toUpperCase().includes('GERENTE GENERAL') ? 0 : 1;
          if (aGG !== bGG) return aGG - bGG;
          return (a.puesto || '').localeCompare((b.puesto || ''), 'es');
        });
      } else {
        list.sort((a, b) => (a.puesto || '').localeCompare((b.puesto || ''), 'es'));
      }
      const collapseId = `depCollapse_${depIdx}`;
      const headingId = `depHeading_${depIdx}`;
      const openByDefault = depIdx === 0; // abre la primera sección (ej. Dirección)
    %>

    <div class="accordion-item">
      <h2 class="accordion-header" id="<%= headingId %>">
        <button class="accordion-button <%= openByDefault ? '' : 'collapsed' %>" type="button"
                data-bs-toggle="collapse" data-bs-target="#<%= collapseId %>"
                aria-expanded="<%= openByDefault ? 'true' : 'false' %>" aria-controls="<%= collapseId %>">
          <strong><%= depName %></strong>
          <span class="badge bg-secondary ms-2"><%= list.length %></span>
        </button>
      </h2>
      <div id="<%= collapseId %>" class="accordion-collapse collapse <%= openByDefault ? 'show' : '' %>"
           aria-labelledby="<%= headingId %>" data-bs-parent="#puestosAccordion">
        <div class="accordion-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width:60px;">#</th>
                  <th>Puesto</th>
                  <th style="min-width:220px;">Responde a</th>
                  <th style="width:150px;">Rol</th>
                  <th style="width:220px;">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <% list.forEach((p, idx) => { %>
                  <tr>
                    <form method="post" action="/puestos/editar/<%= p.id %>">
                      <td><%= idx + 1 %></td>
                      <td>
                        <input type="text" name="nombre" value="<%= p.puesto %>" class="form-control form-control-sm" required>
                        <div class="mt-1">
                          <select name="departamento_id" class="form-select form-select-sm" required>
                            <% departamentos.forEach(dep => { %>
                              <option value="<%= dep.id %>" <%= dep.nombre === p.departamento ? 'selected' : '' %>><%= dep.nombre %></option>
                            <% }) %>
                          </select>
                        </div>
                      </td>
                      <td>
                        <select name="responde_a_id" class="form-select form-select-sm">
                          <option value="">Sin jefe directo</option>
                          <% puestos.forEach(j => { %>
                            <% if (j.id !== p.id) { %>
                              <option value="<%= j.id %>" <%= (p.responde_id && j.id === p.responde_id) ? 'selected' : '' %>><%= j.puesto %></option>
                            <% } %>
                          <% }) %>
                        </select>
                      </td>
                      <td>
                        <% if (isAdmin) { %>
                          <select name="role" class="form-select form-select-sm">
                            <% roles.forEach(function(r) { %>
                              <option value="<%= r %>" <%= p.role === r ? 'selected' : '' %>><%= r.charAt(0).toUpperCase() + r.slice(1) %></option>
                            <% }); %>
                          </select>
                        <% } else { %>
                          <span class="badge bg-secondary"><%= (p.role || 'user').charAt(0).toUpperCase() + (p.role || 'user').slice(1) %></span>
                        <% } %>
                      </td>
                      <td class="text-nowrap">
                        <a href="/puestos/<%= p.id %>" class="btn btn-sm btn-primary me-1">Asignar KPIs</a>
                        <button type="submit" class="btn btn-sm btn-success">Guardar</button>
                      </td>
                    </form>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  <% }) %>
</div>

<hr>
<h3>Crear Departamento</h3>
<form method="post" action="/puestos/crear-departamento" class="row g-3 mb-4">
  <div class="col-auto">
    <input type="text" name="nombre" placeholder="Nombre del departamento" class="form-control" required>
  </div>
  <div class="col-auto">
    <button type="submit" class="btn btn-success">Agregar departamento</button>
  </div>
</form>

<h3>Agregar Sucursal al Departamento OPERACIONES</h3>
<form method="post" action="/puestos/crear-sucursal" class="row g-3">
  <div class="col-auto">
    <input type="text" name="nombre" placeholder="Nombre de la sucursal" class="form-control" required>
  </div>
  <div class="col-auto">
    <button type="submit" class="btn btn-success">Agregar sucursal</button>
  </div>
</form>

<hr>
<h3>Crear Puesto</h3>
<form method="post" action="/puestos/crear" class="row g-3">
  <div class="col-md-3">
    <input type="text" name="nombre" placeholder="Nombre del puesto" class="form-control" required>
  </div>
  <div class="col-md-3">
    <select name="departamento_id" class="form-select" required>
      <% departamentos.forEach(dep => { %>
        <option value="<%= dep.id %>"><%= dep.nombre %></option>
      <% }) %>
    </select>
  </div>
  <div class="col-md-3">
    <select name="responde_a_id" class="form-select">
      <option value="">Sin jefe directo</option>
      <% puestos.forEach(p => { %>
        <option value="<%= p.id %>"><%= p.puesto %></option>
      <% }) %>
    </select>
  </div>
  <% if (isAdmin) { %>
    <div class="col-md-2">
      <select name="role" class="form-select">
        <% roles.forEach(function(r) { %>
          <option value="<%= r %>"><%= r.charAt(0).toUpperCase() + r.slice(1) %></option>
        <% }); %>
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-success">Crear puesto</button>
    </div>
  <% } else { %>
    <div class="col-md-3">
      <button type="submit" class="btn btn-success">Crear puesto</button>
    </div>
  <% } %>
</form>

<%- include('partials/footer') %>