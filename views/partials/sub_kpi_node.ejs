<% const empNoFmt = node.empleado.incidencia_id ? String(node.empleado.incidencia_id).padStart(5,'0') : ''; %>

<%
  /*
   * Calcula el total ponderado del periodo para este empleado.
   * Cada KPI tiene un peso (porcentaje) y un puntaje base (40/70/100) seg√∫n su sem√°foro.
   * El total ponderado es la suma de (puntaje * peso/100) de todos los KPIs asignados.
   */
  let __totalWeighted = 0;
  if (Array.isArray(node.kpis)) {
    node.kpis.forEach(kpi => {
      // Obtener el resultado del mes seleccionado
      const resMap = node.resultados && node.resultados[kpi.id];
      const res = (resMap && resMap[selectedMonth]) || {};
      // Determinar el puntaje base seg√∫n el color
      let __score = null;
      if (res.color === 'rojo') __score = 40;
      else if (res.color === 'amarillo') __score = 70;
      else if (res.color === 'verde') __score = 100;
      // Peso del KPI (porcentaje)
      const __pesoVal = (kpi.peso !== null && kpi.peso !== undefined) ? parseFloat(kpi.peso) : 0;
      if (__score !== null && __pesoVal) {
        __totalWeighted += (__score * (__pesoVal / 100));
      }
    });
  }
  // Formatear con m√°ximo 2 decimales y eliminar ceros finales
  const __totalFormatted = (__totalWeighted || 0).toFixed(2).replace(/\.0+$/, '').replace(/(\.\d*[1-9])0+$/, '$1');
  // Determinar el color general del total ponderado
  let __generalColorClass = '';
  let __generalText = '';
  if (__totalWeighted >= 70) {
    __generalColorClass = 'bg-success text-light';
    __generalText = 'Verde';
  } else if (__totalWeighted >= 40) {
    __generalColorClass = 'bg-warning text-dark';
    __generalText = 'Amarillo';
  } else {
    __generalColorClass = 'bg-danger text-light';
    __generalText = 'Rojo';
  }
%>
<div class="card mb-4 ms-3" data-team-card data-emp-name="<%= node.empleado.nombre || '' %>" data-emp-no="<%= empNoFmt %>" data-emp-dept="<%= node.empleado.departamento_nombre || '' %>">
  <% const fmtDate = (d) => { if (!d) return ''; const dd = new Date(d); if (isNaN(dd.getTime())) return ''; return dd.toLocaleDateString('es-MX'); }; %>
  <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
  <div>
    <strong><%= node.empleado.nombre %></strong>
    <% if (empNoFmt) { %>
      <span class="badge bg-light text-dark border ms-2">#<%= empNoFmt %></span>
    <% } %>
    <% if (node.empleado.puesto_nombre) { %>
      - <%= node.empleado.puesto_nombre %>
    <% } %>
    <% if (node.empleado.departamento_nombre) { %>
      - <%= node.empleado.departamento_nombre %>
    <% } %>
    <!-- Mostrar total ponderado y color general al lado del nombre -->
    <span class="badge bg-light text-dark border ms-2" data-sub-total-weighted><%= __totalFormatted %></span>
    <span class="badge <%= __generalColorClass %> ms-1" data-sub-total-color><%= __generalText %></span>
  </div>
  <div class="btn-group">
    <button type="button" class="btn btn-sm btn-outline-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
      Exportar KPIs
    </button>
    <ul class="dropdown-menu dropdown-menu-end">
      <li>
        <a class="dropdown-item" href="/dashboard/export/employee/<%= node.empleado.id %>?anio=<%= selectedYear %>&mes=<%= selectedMonth %>&mode=period">
          Periodo (mes)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="/dashboard/export/employee/<%= node.empleado.id %>?anio=<%= selectedYear %>&mes=<%= selectedMonth %>&mode=annual">
          Historial anual
        </a>
      </li>
    </ul>
  </div>
</div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>KPI</th>
            <th>Objetivo</th>
            <th>Unidad</th>
            <th>Criterios de calificaci√≥n</th>
            <!-- Cambiamos "Resultado" por "Calificaci√≥n" y a√±adimos columnas de Peso (%) y Puntaje ponderado -->
            <th class="text-center">Calificaci√≥n</th>
            <th class="text-center">Peso&nbsp;(%)</th>
            <th class="text-center">Puntaje&nbsp;ponderado</th>
            <th>Comentarios</th>
          </tr>
        </thead>
        <tbody>
          <% node.kpis.forEach(kpi => {
               const res = (node.resultados[kpi.id] && node.resultados[kpi.id][selectedMonth]) || {};
               const isLocked = (res.visto_bueno === 1);
               let colorClass = '';
               if (res.color === 'rojo') colorClass = 'bg-danger text-light';
               if (res.color === 'amarillo') colorClass = 'bg-warning';
               if (res.color === 'verde') colorClass = 'bg-success text-light';
               const puntaje = res.color === 'rojo' ? 40 : (res.color === 'amarillo' ? 70 : (res.color === 'verde' ? 100 : ''));
          %>
          <tr
            data-kpi-row
            data-empleado-id="<%= node.empleado.id %>"
            data-kpi-id="<%= kpi.id %>"
            data-can-approve="<%= node.canApprove ? '1' : '0' %>"
            data-score-type="<%= (kpi.score_type || '').toUpperCase() %>"
            data-direction="<%= (kpi.direction || 'HIGHER_BETTER').toUpperCase() %>"
            data-threshold-yellow="<%= (kpi.threshold_yellow !== null && kpi.threshold_yellow !== undefined) ? kpi.threshold_yellow : '' %>"
            data-threshold-green="<%= (kpi.threshold_green !== null && kpi.threshold_green !== undefined) ? kpi.threshold_green : '' %>"
            data-criterion-red="<%= kpi.criterion_red || '' %>"
            data-criterion-yellow="<%= kpi.criterion_yellow || '' %>"
            data-criterion-green="<%= kpi.criterion_green || '' %>"
            data-weight="<%= (kpi.peso !== null && kpi.peso !== undefined) ? kpi.peso : 0 %>"
          >
            <td><%= kpi.nombre %></td>
            <td><%= kpi.objetivo %></td>
            <td><%= kpi.unidad %></td>
            <td>
              <%
                const fmt = (v) => {
                  if (v === null || v === undefined || v === '') return '';
                  const n = Number(v);
                  if (!Number.isFinite(n)) return String(v);
                  const s = String(n);
                  return s.replace(/\.0+$/,'').replace(/(\.\d*[1-9])0+$/,'$1');
                };
              %>
              <% if (kpi.score_type === 'CRITERION') { %>
                <small>
                  R: <%= kpi.criterion_red || '-' %><br>
                  A: <%= kpi.criterion_yellow || '-' %><br>
                  V: <%= kpi.criterion_green || '-' %>
                </small>
              <% } else if (kpi.threshold_yellow == null || kpi.threshold_green == null) { %>
                <small class="text-muted">Sin criterios definidos</small>
              <% } else { %>
                <small>
                  <span class="text-muted">Sentido:</span> <strong><%= (kpi.direction === 'LOWER_BETTER') ? '‚Üì' : '‚Üë' %></strong><br>
                  <span class="text-muted">Amarillo:</span> <strong><%= fmt(kpi.threshold_yellow) %></strong><br>
                  <span class="text-muted">Verde:</span> <strong><%= fmt(kpi.threshold_green) %></strong>
                  <div class="text-muted" style="font-size: 11px; line-height: 1.2; margin-top:4px;">
                    Rojo: <%= (kpi.direction === 'LOWER_BETTER') ? 'mayor a Amarillo' : 'menor a Amarillo' %>
                  </div>
                </small>
              <% } %>
            </td>
            <td>
              <form method="post" action="/dashboard/save" class="d-flex align-items-center" data-kpi-form data-kpi-id="<%= kpi.id %>">
                <input type="hidden" name="empleado_id" value="<%= node.empleado.id %>">
                <input type="hidden" name="kpi_id" value="<%= kpi.id %>">
                <input type="hidden" name="anio" value="<%= selectedYear %>">
                <input type="hidden" name="mes" value="<%= selectedMonth %>">
                <% if (kpi.score_type === 'CRITERION') { %>
                  <select class="form-select form-select-sm <%= colorClass %>" name="valor" data-kpi-valor style="width:140px;" <%= isLocked ? 'disabled' : '' %>>
                    <option value="" <%= (!res.valor) ? 'selected' : '' %>>--</option>
                    <% if (kpi.criterion_red) { %><option value="<%= kpi.criterion_red %>" <%= res.valor===kpi.criterion_red ? 'selected' : '' %>><%= kpi.criterion_red %></option><% } %>
                    <% if (kpi.criterion_yellow) { %><option value="<%= kpi.criterion_yellow %>" <%= res.valor===kpi.criterion_yellow ? 'selected' : '' %>><%= kpi.criterion_yellow %></option><% } %>
                    <% if (kpi.criterion_green) { %><option value="<%= kpi.criterion_green %>" <%= res.valor===kpi.criterion_green ? 'selected' : '' %>><%= kpi.criterion_green %></option><% } %>
                  </select>
                <% } else { %>
                  <input type="text" class="form-control form-control-sm <%= colorClass %>" name="valor" value="<%= res.valor || '' %>" style="width:75px;" data-kpi-valor <%= isLocked ? 'disabled' : '' %>>
                <% } %>
                <button type="submit" class="btn btn-sm btn-outline-primary ms-1" title="Guardar" <%= isLocked ? 'disabled' : '' %>><span>‚úî</span></button>

                <!-- Puntaje dentro del sem√°foro -->
                <span class="badge ms-2 <%= (res.color==='rojo') ? 'bg-danger text-light' : (res.color==='amarillo' ? 'bg-warning text-dark' : (res.color==='verde' ? 'bg-success text-light' : 'bg-light text-dark border')) %>"
                      data-kpi-scorebadge
                      style="min-width:52px; text-align:center; <%= puntaje === '' ? 'display:none;' : '' %>">
                  <%= puntaje %>
                </span>
              </form>
              <% const estado = isLocked ? 'APROBADO' : (res.revision_por ? 'EN REVISI√ìN' : 'ABIERTO');
                 const estadoClass = (estado === 'APROBADO') ? 'bg-success text-light' : (estado === 'EN REVISI√ìN' ? 'bg-warning text-dark' : 'bg-secondary text-light');
              %>
              <div class="d-flex align-items-center flex-wrap gap-1 mt-1">
                <span class="badge <%= estadoClass %>" data-status-badge><%= estado %></span>
                <small class="text-muted" data-status-meta>
                  <% if (estado === 'APROBADO') { %>
                    por <strong><%= res.visto_nombre || '‚Äî' %></strong> ¬∑ <%= fmtDate(res.visto_fecha) || '' %>
                  <% } else if (estado === 'EN REVISI√ìN') { %>
                    por <strong><%= res.revision_nombre || '‚Äî' %></strong> ¬∑ <%= fmtDate(res.revision_fecha) || '' %>
                    <% if (res.revision_motivo) { %>
                      <span class="text-muted">¬∑ <em><%= res.revision_motivo %></em></span>
                    <% } %>
                  <% } %>
                </small>

                <button type="button"
                        class="btn btn-sm btn-outline-success ms-2 <%= (node.canApprove && estado !== 'APROBADO') ? '' : 'd-none' %>"
                        data-lock-toggle data-action="approve">
                  ‚úÖ Aprobar
                </button>

                <button type="button"
                        class="btn btn-sm btn-outline-warning ms-1 <%= (node.canSendToReview && estado === 'APROBADO') ? '' : 'd-none' %>"
                        data-lock-toggle data-action="review">
                  ‚Ü© Reabrir
                </button>

                <% if (estado === 'APROBADO') { %>
                  <span class="badge bg-dark ms-1" data-lock-badge title="Aprobado / cerrado">üîí</span>
                <% } %>
              </div>
            </td>
            <!-- Peso (%) -->
            <td class="text-center">
              <% if (kpi.peso !== null && kpi.peso !== undefined) { %>
                <%= Number(kpi.peso).toFixed(2).replace(/\.0+$/,'').replace(/(\.\d*[1-9])0+$/,'$1') %>
              <% } else { %>
                ‚Äî
              <% } %>
            </td>
            <!-- Puntaje ponderado -->
            <td class="text-center">
              <%
                // Calcular puntaje ponderado usando el puntaje (100/70/40) y el peso (%).
                let __wsClass = 'bg-light text-dark border';
                let __weighted = '';
                const __pesoVal = (kpi.peso !== null && kpi.peso !== undefined) ? Number(kpi.peso) : 0;
                if (puntaje !== '' && __pesoVal) {
                  const __ws = (Number(puntaje) * (__pesoVal / 100));
                  __weighted = __ws.toFixed(2).replace(/\.0+$/,'').replace(/(\.\d*[1-9])0+$/,'$1');
                  if (res.color === 'rojo') __wsClass = 'bg-danger text-light';
                  else if (res.color === 'amarillo') __wsClass = 'bg-warning text-dark';
                  else if (res.color === 'verde') __wsClass = 'bg-success text-light';
                }
              %>
              <span class="badge <%= __wsClass %>"><%= __weighted || '‚Äî' %></span>
            </td>
            <td>
              <form method="post" action="/dashboard/save" data-kpi-comment-form data-kpi-id="<%= kpi.id %>" class="d-flex gap-1 align-items-start">
                <input type="hidden" name="empleado_id" value="<%= node.empleado.id %>">
                <input type="hidden" name="kpi_id" value="<%= kpi.id %>">
                <input type="hidden" name="anio" value="<%= selectedYear %>">
                <input type="hidden" name="mes" value="<%= selectedMonth %>">
                <!-- comentario sin forzar valor -->
                <textarea name="comentario" class="form-control form-control-sm" rows="1" style="min-width:220px;" placeholder="Comentario..." <%= isLocked ? 'disabled' : '' %>><%= res.comentario || '' %></textarea>
                <button type="submit" class="btn btn-sm btn-outline-secondary" title="Guardar comentario" <%= isLocked ? 'disabled' : '' %>>üíæ</button>
              </form>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>

    <!-- Resumen de puntajes ponderados del periodo para este colaborador -->
    <div class="mt-2 d-flex align-items-center flex-wrap gap-2">
      <!-- Etiqueta de resumen m√°s intuitiva -->
      <strong>Resultado final del mes:</strong>
      <span class="badge bg-light text-dark border" data-sub-total-weighted><%= __totalFormatted %></span>
      <span class="badge <%= __generalColorClass %>" data-sub-total-color><%= __generalText %></span>
    </div>
    <!-- Retroalimentaci√≥n del periodo (plegable) -->
    <div class="mt-2">
      <button class="btn btn-sm btn-outline-secondary" type="button"
              data-toggle-retro data-target="#retro-emp-<%= node.empleado.id %>">
        ‚ñ∏ Desplegar retro
      </button>
      <div id="retro-emp-<%= node.empleado.id %>" class="border rounded p-2 mt-2" style="display:none;">
        <form method="post" action="/dashboard/feedback/save" data-feedback-form>
          <input type="hidden" name="empleado_id" value="<%= node.empleado.id %>">
          <input type="hidden" name="anio" value="<%= selectedYear %>">
          <input type="hidden" name="mes" value="<%= selectedMonth %>">
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label small mb-1">Fortalezas</label>
              <textarea name="fortalezas" class="form-control form-control-sm" rows="3" placeholder="Fortalezas..."><%= (node.feedback && node.feedback.fortalezas) || '' %></textarea>
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">√Åreas de oportunidad</label>
              <textarea name="oportunidades" class="form-control form-control-sm" rows="3" placeholder="√Åreas de oportunidad..."><%= (node.feedback && node.feedback.oportunidades) || '' %></textarea>
            </div>
            <div class="col-md-4">
              <label class="form-label small mb-1">Compromisos</label>
              <textarea name="compromisos" class="form-control form-control-sm" rows="3" placeholder="Compromisos..."><%= (node.feedback && node.feedback.compromisos) || '' %></textarea>
            </div>
          </div>
          <div class="mt-2 d-flex align-items-center gap-2">
            <button type="submit" class="btn btn-sm btn-primary">Guardar retro</button>
            <span data-feedback-status class="text-muted small"></span>
          </div>
        </form>
      </div>
    </div>
    <% if (node.hasChildren) { %>
      <!-- Carga bajo demanda: solo se trae UN NIVEL por click. -->
      <button type="button"
              class="btn btn-sm btn-outline-secondary mt-2"
              data-subtree-btn
              data-emp-id="<%= node.empleado.id %>">
        ‚ñ∏ Desplegar nivel
      </button>
      <div id="subtree-<%= node.empleado.id %>" data-subtree-container style="display:none;"></div>
    <% } %>
  </div>
</div>